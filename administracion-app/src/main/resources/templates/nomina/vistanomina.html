<!DOCTYPE html>
<html lang="en">
<head th:replace="fragments/header :: head('Nomina')">
    <meta charset="UTF-8" />
    <title>Nomina</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}"/>
    <script th:src="@{/js/script.js}"></script>
</head>
<body>
<div th:replace="/fragments/cabecera"></div>
<main>
    <div class="absoluto mt-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-2"></div>
                <div class="col">
                    <h1 class="text-center mb-2">Nomina</h1>
                </div>
                <div class="col-2"></div>
            </div>

            <div>
                <p class="error-message" th:text="${error}"></p>
            </div>

            <form id="nominaForm" method="post" th:object="${nominaDTO}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" th:value="${empleadoId}" name="empleadoId">

                <div class="mb-3">
                    <label for="fechaInicio" class="form-label">Fecha Inicio:</label>
                    <input type="text" id="fechaInicio" name="fechaInicio" class="form-control" th:field="*{periodo.fechaInicio}">
                    <span class="error-message" th:if="${#fields.hasErrors('periodo.fechaInicio')}" th:errors="*{periodo.fechaInicio}"></span>
                </div>

                <div class="mb-3">
                    <label for="fechaFin" class="form-label">Fecha Fin:</label>
                    <input type="text" id="fechaFin" name="fechaFin" class="form-control" th:field="*{periodo.fechaFin}">
                    <span class="error-message" th:if="${#fields.hasErrors('periodo.fechaFin')}" th:errors="*{periodo.fechaFin}"></span>
                </div>

                <div id="lineasNominaContainer">
                    <div class="linea-nomina mb-3" data-linea-index="0">
                        <label class="form-label">Línea de Nómina 1:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="concepto_0" class="form-label">Concepto:</label>
                                <input type="text" id="concepto_0" name="lineas[0].concepto" class="form-control" th:field="*{lineas[0].concepto}" value="Salario" >
                                <span class="error-message" th:if="${#fields.hasErrors('lineas[0].concepto')}" th:errors="*{lineas[0].concepto}"></span>
                            </div>
                            <div class="col-md-4">
                                <label for="importe_0" class="form-label">Importe:</label>
                                <input type="text" id="importe_0" name="lineas[0].importe" class="form-control" th:field="*{lineas[0].importe}">
                                <span class="error-message" th:if="${#fields.hasErrors('lineas[0].importe')}" th:errors="*{lineas[0].importe}"></span>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" id="anadirLinea" class="btn btn-success w-100 mt-3">Añadir Línea de Nómina</button>

                <button type="button" id="enviarNomina" class="btn btn-primary w-100 mt-3">Enviar Nomina</button>

                <a href="/login/username" class="btn btn-secondary w-100 mt-3">Iniciar Sesion</a>
            </form>
        </div>
    </div>
</main>
<div th:replace="/fragments/pie"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script th:src="@{/js/jquery.serializeJSON.min.js}"></script>
<script>
    $(document).ready(function() {
        let lineaIndex = 1; // Empezamos en 1 porque ya hay una línea inicial

        function actualizarEstadoBotonesQuitar() {
            $('.quitar-linea').prop('disabled', $('.linea-nomina').length <= 1);
            $('.linea-nomina:first-child .quitar-linea').prop('disabled', true);
        }

        function reindexarLineas() {
            $('.linea-nomina').each(function(index) {
                $(this).attr('data-linea-index', index);
                $(this).find('label:first-child').text(`Línea de Nómina ${index + 1}:`);
                $(this).find('[id^="concepto_"]').attr('id', `concepto_${index}`).attr('name', `lineas[${index}].concepto`);
                $(this).find('[id^="importe_"]').attr('id', `importe_${index}`).attr('name', `lineas[${index}].importe`);
                const quitarBoton = $(this).find('.quitar-linea');
                if (quitarBoton.length > 0) {
                    quitarBoton.attr('data-linea-index', index);
                }
            });
        }

        $('#anadirLinea').click(function() {
            const nuevaLineaHtml = `
                <div class="linea-nomina mb-3" data-linea-index="${lineaIndex}">
                    <label class="form-label">Línea de Nómina ${lineaIndex + 1}:</label>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="concepto_${lineaIndex}" class="form-label">Concepto:</label>
                            <input type="text" id="concepto_${lineaIndex}" name="lineas[${lineaIndex}].concepto" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="importe_${lineaIndex}" class="form-label">Importe:</label>
                            <input type="text" id="importe_${lineaIndex}" name="lineas[${lineaIndex}].importe" class="form-control">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm quitar-linea" data-linea-index="${lineaIndex}">Quitar</button>
                        </div>
                    </div>
                </div>
            `;
            $('#lineasNominaContainer').append(nuevaLineaHtml);
            lineaIndex++;
            actualizarEstadoBotonesQuitar();
        });

        $('#lineasNominaContainer').on('click', '.quitar-linea', function() {
            const indexToRemove = $(this).data('linea-index');
            const lineaIdToRemove = $(this).data('linea-id'); // Obtener el ID de la línea (si existe)

            if (lineaIdToRemove) {
                // Enviar petición DELETE a tu API REST para eliminar la línea
                $.ajax({
                    type: 'DELETE',
                    url: `/api/lineas-nomina/${lineaIdToRemove}`, // Define tu endpoint de la API
                    success: function(response) {
                        console.log('Línea de nómina eliminada:', response);
                        $(`.linea-nomina[data-linea-index="${indexToRemove}"]`).remove();
                        actualizarEstadoBotonesQuitar();
                        reindexarLineas();
                        window.location.href = `/nomina/empleado/${empleadoId}/listar`;
                    },
                    error: function(error) {
                        console.error('Error al eliminar la línea de nómina:', error);
                        alert('No se pudo eliminar la línea de nómina.');
                    }
                });
            } else {
                // Si no hay ID (líneas añadidas dinámicamente y no guardadas)
                $(`.linea-nomina[data-linea-index="${indexToRemove}"]`).remove();
                actualizarEstadoBotonesQuitar();
                reindexarLineas();
            }
        });

        $('#enviarNomina').click(function(event) {
            event.preventDefault();

            const formData = $('#nominaForm').serializeJSON(); // Se necesita la librería jquery.serializeJSON.js
            const empleadoId = $('input[name="empleadoId"]').val(); // Obtener el ID del empleado
            console.log("Empleado ID antes de enviar la petición:", empleadoId);

            $.ajax({
                type: 'POST',
                url: `/api/nominas?empleadoId=${empleadoId}`, // Ajusta la URL según tu API REST
                contentType: 'application/json',
                data: JSON.stringify(formData),
                dataType: 'json',
                success: function(response) {
                    console.log('Éxito al guardar la nómina:', response);
                    // Redirigir o mostrar mensaje de éxito
                },
                error: function(error) {
                    console.error('Error al guardar la nómina:', error);
                    // Mostrar mensaje de error al usuario
                }
            });
        });

        // Inicialización al cargar el documento
        actualizarEstadoBotonesQuitar();
    });

</script>


</body>
</html>